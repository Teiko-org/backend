name: Deploy Backend to EC2

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Ambiente de destino (ex: lab, prod)"
        required: false
        default: "lab"

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (somente para referência)
        uses: actions/checkout@v4

      - name: Deploy backend em EC2 privadas
        uses: appleboy/ssh-action@v1.2.0
        with:
          # Conectamos nas instâncias privadas via bastion (proxy SSH).
          host: ${{ secrets.BACKEND_PRIVATE_HOSTS }}
          username: ${{ secrets.BACKEND_EC2_USER }}
          key: ${{ secrets.BACKEND_EC2_SSH_KEY }}
          proxy_host: ${{ secrets.BASTION_HOSTS }}
          proxy_username: ${{ secrets.BASTION_USER }}
          proxy_key: ${{ secrets.BASTION_SSH_KEY }}
          script: |
            set -euo pipefail

            echo "[ci-backend] Preparando /opt/teiko..."
            sudo mkdir -p /opt/teiko
            sudo chown -R "$USER":"$USER" /opt/teiko
            cd /opt/teiko

            # Atualiza/clona infra
            if [ -d infra ]; then
              sudo git -C infra fetch --all --prune || true
              sudo git -C infra reset --hard origin/main || true
            else
              sudo git clone https://github.com/Teiko-org/infra.git infra
            fi

            cd /opt/teiko

            echo "[ci-backend] Rodando setup-aws-private.sh (backend + RabbitMQ, banco externo)..."
            SHARED_JWT="${SHARED_JWT:-${JWT_SECRET:-${{ secrets.SHARED_JWT }}}}" \
            AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
            AZURE_STORAGE_CONTAINER_NAME="${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}" \
            DB_HOST="${{ secrets.DB_HOST }}" \
            DB_NAME="${{ secrets.DB_NAME }}" \
            DB_USERNAME="${{ secrets.DB_USERNAME }}" \
            DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            FORCE_INFRA_UPDATE=1 \
            sudo -E bash /opt/teiko/infra/aws-ec2/setup-aws-private.sh


